!function(t,e){if("function"==typeof define&&define.amd)define(["mk-ui","mk-ui/Selectmenu"],function(i,s){return e(t,i,s)});else{if("object"!=typeof module||!module.exports)return e(t,t.Mk,t.Mk.Selectmenu);module.exports=e(t,require("mk-ui"),require("mk-ui/Selectmenu"))}}("undefined"!=typeof window&&window||this,function(t,e,i){if("undefined"==typeof i)throw new Error("Mk.Autocomplete: Selectmenu base class not found.");return e.create("Autocomplete",i,{name:"mk-ac",NOTIFY_STATES:{EMPTY:0,ERROR:1,CAPACITY:2,LOADING:3,LOADED:4,ABORT:5},templates:{shadow:'<div class="{{$key}}-shadow">\t\t\t\t\t{{template:tags}}\t\t\t\t\t{{template:trigger}}\t\t\t\t\t{{scope:list}}{{template:list}}{{/scope:list}}\t\t\t\t\t{{template:notifications}}\t\t\t\t</div>',tags:'<ul class="{{$key}}-tags" aria-label="Current selections"></ul>',tag:'<li class="{{$key}}-tag" role="presentation" data-value="{{value}}">\t\t\t\t\t<a href="javascript:void(0);" \t\t\t\t\t\trole="button" \t\t\t\t\t\tdata-value="{{value}}" \t\t\t\t\t\tdata-action="remove" \t\t\t\t\t\taria-label="Remove {{label}}"></a>\t\t\t\t\t{{label}}\t\t\t\t</li>',trigger:'<div class="{{$key}}-trigger {{if:disabled}} disabled{{/if:disabled}}" \t\t\t\t\trole="combobox" \t\t\t\t\taria-haspopup="listbox">\t\t\t\t\t{{template:input}}\t\t\t\t\t{{template:submit}}\t\t\t\t\t{{template:live}}\t\t\t\t</div>',input:'<input type="text" \t\t\t\t\tclass="{{$key}}-input" \t\t\t\t\tautocomplete="off" \t\t\t\t\taria-autocomplete="list" \t\t\t\t\t{{if:disabled}}aria-disabled="true" disabled {{/if:disabled}}\t\t\t\t\t{{if:multiple}}aria-multiselectable="true" {{/if:multiple}}\t\t\t\t\tvalue="{{label}}" />',submit:'<button class="mk-ac-submit" aria-label="{{submit}}"></button>',live:'<div class="{{$key}}-live sr-only" \t\t\t\t\taria-atomic="true" \t\t\t\t\taria-live="assertive">\t\t\t\t</div>',notifications:'<div class="{{$key}}-notifications" \t\t\t\t\taria-atomic="true" \t\t\t\t\taria-live="assertive">\t\t\t\t</div>',list:'<ul id="{{id}}" class="{{$key}}-list" role="listbox">\t\t\t\t\t{{loop:items}}{{template:item}}{{/loop:items}}\t\t\t\t</ul>',category:'<li class="{{$key}}-category" role="presentation">\t\t\t\t\t<span id="{{id}}" role="presentation">\t\t\t\t\t\t<span class="{{$key}}-label">{{label}}</span>\t\t\t\t\t</span>\t\t\t\t</li>',item:'<li class="{{$key}}-item" role="presentation">\t\t\t\t\t<a id="{{id}}" \t\t\t\t\t\tclass="{{$key}}-option" \t\t\t\t\t\trole="option" \t\t\t\t\t\thref="javascript: void(0);" \t\t\t\t\t\taria-selected="{{selected}}" \t\t\t\t\t\taria-disabled="{{disabled}}" \t\t\t\t\t\tdata-value="{{$value}}">\t\t\t\t\t\t<span class="{{$key}}-label">\t\t\t\t\t\t\t{{highlight:label}}\t\t\t\t\t\t</span>\t\t\t\t\t\t{{if:alt}}\t\t\t\t\t\t\t<span class="{{$key}}-alt">{{alt}}</span>\t\t\t\t\t\t{{/if:alt}}\t\t\t\t\t</a>\t\t\t\t</li>'},formats:{submit:"Search for {{query}}",loading:"Searching for {{query}}",loaded:"{{count}} results loaded for {{query}}",error:"Whoops, looks like we're having issues with {{highlight:query}}",empty:"No results found for {{highlight:query}}",capacity:"You've reached your tag limit",label:"Autocomplete"},get version(){return"v2.0.0"},get input(){return this.node("input",this.shadow)},get tagroot(){return this.node("tags",this.shadow)},get tags(){return this.node("tag",this.tagroot)},get live(){return this.node("live",this.shadow)},get notifications(){return this.node("notifications",this.shadow)},get isLoading(){return this.shadow.hasClass("loading")},get limit(){return this.config.limit},get doubledelete(){return this.config.doubledelete},get multiple(){return this.limit>1},get capacity(){return this.selections.length>=this.limit},get anything(){return this.config.anything},get searchvalues(){return this.config.searchvalues},get value(){return this.selections.length>0?this.flatten(this.multiple&&this.selections||this.selections[0]):null},get empty(){return this.items.length<1},get remote(){var t=this.events.request||[];return this.first(t,function(t){if(".send"===t.namespace)return!0})},deletecount:0,selections:null,requests:0,cache:null,query:"",verifyRoot:function(t){this.node("",t);if(!this.node("",t).is("input"))throw new Error(":: Mk.Autocomplete - root must have a text <input> node ::");return!0},define:function(t,e){this.query="",this.selections=[],this.requests=0,this.cache={},this.super(t,e)},configure:function(t,e){t=t||{},t.data=t.data||null;var i=this.rootelement,s=i.attr("aria-label")||this.formats.label;this.param("label","string",t,s,i).param("limit","number",t,1,i).param("time","number",t,500,i).param("doubledelete","boolean",t,t.limit>1,i).param("anything","boolean",t,!0,i).param("comma","boolean",t,!1,i).param("notags","boolean",t,!1,i).param("chars","number",t,1,i).param("searchvalues","boolean",t,!0,i),e!==!0&&this.super(t)},unmount:function(){this.shadow.remove(),this.shadow=this.events=this.config=this.selections=this.cache=this.root=null},build:function(){this.super(),this.input.attr("placeholder",this.rootelement.attr("placeholder")),this.updateTagroot()},updateTagroot:function(){var t="removeClass",e="false";return this.config.notags&&(t="addClass",e="true"),this.shadow[t]("no-tags"),this.tagroot.attr("aria-hidden",e),this},bind:function(){this.on("request.error",this.error),this.bindInputEvents(),this.bindListEvents(),this.bindLabelEvents()},bindLabelEvents:function(){var t=this;this.tagroot.on("click.mk",'[data-action="remove"]',function(e){e.preventDefault(),t.deselect(this.getAttribute("data-value"))})},bindInputEvents:function(){var t=this,e=this.trigger;this.node("submit").on("click.mk",function(e){e.preventDefault(),t.emit("submit")}),this.input.on("focus.mk",function(t){e.addClass("focus")}).on("blur.mk",function(i){e.removeClass("focus"),t.hide(),this.disabled||t.blur()}).on("keydown.mk",function(e){t._keydown(e)}).on("keyup.mk",function(e){t._keyup(e)})},_keyIsBehavior:function(t){var e=this.keycode;switch(t){case e.space:case e.tab:return 0;case e.enter:case e.up:case e.down:case e.left:case e.right:case e.esc:return 1}return-1},_esc:function(t){this.notify(),this.super(t)},_keydown:function(t){if(!this.disabled){var e=(this.input.val(),t.which),i=this.keycode;switch(e){case i.enter:return this._enter(t);case i.space:return this._space(t);case i.esc:return this._esc(t);case i.up:case i.down:return t.preventDefault(),this.move(e===i.up);case i.tab:if(this.isOpen)return this._tab(t)}}},_keyup:function(t){if(!this.disabled){this.timer&&(clearTimeout(this.timer),this.timer=null);var e=this.input.val(),i=t.which,s=this.keycode,a=this._keyIsBehavior(i);return a>-1?void(1===a&&t.preventDefault()):i!==s.backspace||e?(this.deletecount=0,i===s.comma&&this.anything&&this.config.comma?this._comma(e):void(this.timer=this.delay(function(){return this.search(e)},this.config.time))):this._popByDelete().abort().clear()}},_space:function(t){!this.timer&&this.isHidden&&this.items.length>0&&(t.preventDefault(),this.show())},_enter:function(t){t.preventDefault();var e=this.items.find(".active"),i=e.data("value"),s=this.input.val(),a=this.isHidden;if(s&&a&&this.anything)return this.abort().select(this.flatten({label:s,value:s}));if(a&&!this.empty)return this.show();if(e.length)if("true"!==e.attr("aria-selected"))this.select(i);else{if(!this.multiple)return this.show();this.deselect(i)}return this.multiple?void 0:this.hide()},_render:function(t){var e=this.list;this.each(t,function(t,i){return t.hasOwnProperty("items")?void(t.items.length>0&&(e.append(this.html("category",t)),this._render(t.items))):void e.append(this.html("item",t))})},_comma:function(t){var e=t.split(/\,\s{0,}/),i=!0,s=!1;return this.each(e,function(t){t&&(i&&(this.abort(),i=!1),s=!0,this.select(this.flatten({label:t,value:t})))}),s&&(this.abort().clear(),this.multiple&&this.input.val("")),this},_popByDelete:function(){return this.doubledelete&&(this.deletecount>0?(this.deletecount=0,this.pop()):this.deletecount=1),this},move:function(t){if(this.empty){if(!this.hasCache())return;this.search()}if(this.isHidden)return this.show();var e=this.items,i=e.find(".active")[0],s=i&&this.index(i);return 0===s&&t||s===e.length-1&&!t?(this.$(i).removeClass("active"),void this.input.attr("aria-activedescendant","").val(this.query)):void 0===s&&t?(s=e.length-2,this.node("option",e[s]).addClass("active"),void this.super(!1)):void this.super(t)},search:function(t,e){var i=t=t||"";return e===!0&&(i=(this.query||"")+t),this.query=i,this.node("submit").attr("aria-label",this.format("submit",{query:i})),this.hasCache(i)?void this.render(this.getCache(i),i):void(i&&i.length>=this.config.chars&&this.request())},request:function(){return this.remote?(this.abort(),this.notify(this.NOTIFY_STATES.LOADING,this.query),void this.emit("request.send",this.query,++this.requests)):void this.render([],this.query)},flatten:function(t){return t&&btoa(JSON.stringify(t))||""},unflatten:function(t){return t&&JSON.parse(atob(t))||{}},hasCache:function(t){return t=(t||"").toLowerCase(),!(t&&this.remote||!this.config.data)||!!this.cache.hasOwnProperty(t)},getCache:function(t){return t=(t||"").toLowerCase(),t&&this.remote||!this.config.data?this.cache.hasOwnProperty(t)?this.cache[t]:null:this.filterData(t,this.config.data)},setCache:function(t,e){return this.cache[(t||"").toLowerCase()]=e},data:function(t){t=t||this.getCache();var e=this.rootelement.val();"string"==typeof t&&(e=t,t=this.getCache(t));var i=[].slice.apply(this.element.classList),s=this.shadow&&this.shadow.attr("id")||this.uid();return i.splice(i.indexOf(this.name),1),{classname:i.join(" "),multiple:this.multiple,disabled:this.disabled,submit:this.format("submit",{query:e}),list:{id:s,items:[]}}},filterData:function(t,e){if(t){var i=new RegExp(t.replace(/\\/g,"\\\\"),"i");return this.map(e,function(e,s){if(e.hasOwnProperty("items"))return this.map(e,function(e,i){return"items"===i?this.filterData(t,e):e});var a=this.config.searchvalues?i.test(e.label)||i.test(e.value):i.test(e.label);return a?e:void 0})}return e},prepData:function(t,e){var i;return this.map(t,function(t){return i=this.map(t,function(t,i){return"items"===i?this.prepData(t,e):t}),i.$value=this.flatten({label:t.label,value:t.value}),i.highlight=e||"",i.id=this.uid(),i})},select:function(t,e){var i=this.unflatten(t);return this.exists(i.value)?e||this.emit("submit"):(this.limit<2&&this.deselectAll(!0),this.capacity?(this.notify(this.NOTIFY_STATES.CAPACITY),e||this.emit("capacity")):(this.shadow.removeClass("capacity"),this.selections.push(i),this.tag(i).updateRoot(),this.notify(),this.limit<2&&this.input.val(i.label),e||this.emit("change",i)),this.hide()),this},deselect:function(t,e){var i=this.unflatten(t),s=!1;return this.each(this.selections,function(t,e){if(t.value===i.value)return s=!0,-1}),s&&(this.notify(),this.tag(i,!0).updateRoot(),e||this.emit("change",i)),this},deselectAll:function(t){var e=this.selections;if(e.length>0){var i=e.splice(0,e.length);this.notify(),this.tags.remove(),t||this.emit("change",i)}return this},exists:function(t){return this.first(this.selections,function(e,i){if(e.value===t)return!0})},abort:function(){return this.emit("request.abort",--this.requests),this.notify(this.NOTIFY_STATES.ABORT),this},error:function(){return this.notify(this.NOTIFY_STATES.ABORT),this.notify(this.NOTIFY_STATES.ERROR,query),this.hide()},blur:function(){return this.abort()},clear:function(){return this.items.remove(),this.live.text(""),this.hide(),this},pop:function(){if(this.selections.length>0){var t=this.selections.pop();return this.multiple&&this.input.val(t.value),this.abort().tag(t,!0),t}return null},notify:function(t,e,i){e=e||this.query,i=i||null;var s={query:e,count:i,highlight:e},a=this.NOTIFY_STATES,n="",r=!1;switch(t){case a.EMPTY:n="empty";break;case a.ERROR:n="error";break;case a.CAPACITY:n="capacity";break;case a.LOADING:n="loading",r=!0;break;case a.LOADED:n="loaded",r=!0;break;case a.ABORT:r=!0}return r?(this.live.text(""),(t===a.LOADING&&e||e&&null!==i)&&this.live.text(this.format(n,s)),this.shadow[t===a.LOADING&&"addClass"||"removeClass"]("loading")):this.notifications.html(this.format(n,s)),this},tag:function(t,e){var i=this.flatten(t),s={label:t.label,value:i,raw:t};return e?this.tags.filter('[data-value="'+i+'"]').remove():(this.emit("create.tag",s),this.tagroot.append(this.html("tag",s))),this},updateRoot:function(){return this.element.value=this.value,this},render:function(t,e){t=t||[],e=e||this.query;var i=this.prepData(t,e);return this.items.remove(),this.node("category",this.list).remove(),i.length<1?(this.notify(this.NOTIFY_STATES.ABORT),this.notify(this.NOTIFY_STATES.EMPTY,e),this.hide()):(this.events.render&&this.events.render.length>0?this.emit("render",i):this._render(i),this.notify(),this.notify(this.NOTIFY_STATES.LOADED,e,t.length),this.show())},update:function(){this.configure(this.config,!0),this.super(),this.input.attr("placeholder",this.rootinput.attr("placeholder")),this.updateTagroot()}}),e.get("Autocomplete")});